---
title: "GLODAPv2_2020"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths}
path_glodapv2_2021  <- "/nfs/kryo/work/updata/glodapv2_2021/"
path_preprocessing  <- paste(path_root, "/observations/preprocessing/", sep = "")
```

```{r load_libraries_specific, include=FALSE}
library(lubridate)
```

# Read files

Main data source for this project is `GLODAPv2.2021_Merged_Master_File.csv` downloaded from `https://www.ncei.noaa.gov/data/oceans/ncei/ocads/data/0237935/GLODAPv2.2021_Merged_Master_File.csv` on Aug 30, 2021.

```{r read_GLODAPv2_2021_merged_master_file}

GLODAP <-
  read_csv(
    paste(
      path_glodapv2_2021,
      "GLODAPv2.2021_Merged_Master_File_20210830.csv",
      sep = ""
    ),
    na = "-9999",
    col_types = cols(.default = col_double())
  )


GLODAP <- GLODAP %>%
  rename_with(~str_remove(., 'G2'))

```

```{r read_GLODAPv2_2021_adjustment_table}

GLODAP_adjustments <-
  read_csv(
    paste(
      path_glodapv2_2021,
      "GLODAPv2.2021_adjustments_last_updated_on_2021_05_10.csv",
      sep = ""
    ),
    na = c("-666", "-777", "-888", "-999"),
    skip = 2
  )

```

```{r read_GLODAPv2_2021_expocodes_and_doi}

GLODAP_expocodes <-
  read_tsv(
    paste(
      path_glodapv2_2021,
      "EXPOCODES.txt",
      sep = ""
    ),
    col_names = c("cruise", "cruise_expocode")
  )

```

# Data preparation

## Correct qc flag

From an email conversation with Nico Lange

*Yes, we are aware of these faulty(!) calculated TA data (using DIC and fCO2). It is linked to v2.2020 where we've added fCO2 to the "missing carbon calculation matrix". Overall, including fCO2 in these calculations has worked great to fill some missing carbon gaps. However, for this cruise in particular the fCO2 values have most likely been converted wrongly to 20°C and are thus off! The problem of this all is that we haven't really done a 2nd QC on the fCO2 values neither have we defined the corresponding "G2fCO2qc" variable, hence for the sake of consistency we kept all fCO2 values in. Again and unfortunately, in this particular case it led to the bad calculations of TA data.... We plan to do a full 2nd QC on all (!) fCO2 data for v3.*

*But you have indeed found a flaw in our merging script, as the corresponding calculated TA values should not have received a 2nd QC flag of 1! I missed out on adding a line to our merging script to accommodate for the non-existence of 2nd fCO2 flags in the carbon calculation matrix.*

*So long story short: Thank you very much for finding this flaw and letting me know of it!*

and

*Yes, the all calculated TA data from cruise 695 should have a talkqc of 0 (as they are based upon un QC'd fCO2 data...).*

*And no (thanks to your hint and questions), I figured that **this wrongly assigned 2nd QC flag is a problem for all calculated carbon data, which used fCO2 for the calculations**. However, luckily this is not really often the case.*

*You can check if thats the case by looking at which other carbon parameters are measured, i.e. by **checking their primary flags (e.g. G2talkf, G2tco2f and G2phts25p0f and G2fco2f). If only two are measured and one of them is fCO2, it means that the other carbon parameters (the ones with a primary flag of 0) are calculated using fCO2. Hence, for these instances no 2nd QC is done and the corresponding qc flag should be 0 and not 1.***

```{r check_qc_values, eval=FALSE}

GLODAP_qc_check <- GLODAP %>% 
  filter(cruise == 717) %>% 
  count(talkqc)

```


```{r correct_qc_flag}

# calculate number of measured co2 system variables

GLODAP <- GLODAP %>%
  mutate(measured_CO2_vars = rowSums(select(., c(
    tco2f, talkf, fco2f, phts25p0f
  )) == 2))

# identify cruises on which talk/tco2 was calculated

talk_qc_error_cruises <- GLODAP %>%
  select(cruise, tco2:phtsqc, measured_CO2_vars) %>% 
  filter(measured_CO2_vars == 2,
         fco2f == 2,
         talkf == 0) %>% 
  distinct(cruise, talkf, talkqc, fco2f)

tco2_qc_error_cruises <- GLODAP %>%
  select(cruise, tco2:phtsqc, measured_CO2_vars) %>% 
  filter(measured_CO2_vars == 2,
         fco2f == 2,
         tco2f == 0) %>% 
  distinct(cruise, tco2f, tco2qc, fco2f)

talk_qc_error_cruises %>% 
  write_csv("data/talk_qc_error_cruises_GLODAPv2_2021.csv")

tco2_qc_error_cruises %>% 
  write_csv("data/tco2_qc_error_cruises_GLODAPv2_2021.csv")

rm(talk_qc_error_cruises, tco2_qc_error_cruises)


# set qc = 0 for tco2 and talk values calculated from fco2   

GLODAP <- GLODAP %>%
  mutate(tco2qc = if_else(measured_CO2_vars == 2 &
                            fco2f == 2 & tco2f == 0,
                          0,
                          tco2qc))

GLODAP <- GLODAP %>%
  mutate(talkqc = if_else(measured_CO2_vars == 2 &
                            fco2f == 2 & talkf == 0,
                          0,
                          talkqc))

GLODAP <- GLODAP %>% 
  select(-measured_CO2_vars)

```

```{r identify_talk_tco2_calculated_from_pH_fco2, eval=FALSE}

# calculate number of measured co2 system variables

GLODAP <- GLODAP %>%
  mutate(measured_CO2_vars = rowSums(select(., c(
    tco2f, talkf, fco2f, phts25p0f
  )) == 2))

# identify cruises on which talk/tco2 was calculated

tco2_talk_calc <- GLODAP %>%
  select(cruise, tco2:phtsqc, measured_CO2_vars) %>% 
  filter(measured_CO2_vars == 2,
         fco2f == 2,
         phts25p0f == 2)

GLODAP <- GLODAP %>% 
  select(-measured_CO2_vars)

```


## Harmonize nomenclature

```{r harmonize_variables}

# create date column
GLODAP <- GLODAP %>%
  mutate(date = ymd(paste(year, month, day))) %>%
  relocate(date)

# harmonize column names
GLODAP <- GLODAP  %>%
  rename(sal = salinity,
         temp = temperature)

# harmonize coordinates
GLODAP <- GLODAP  %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))


```

## Horizontal gridding

For merging with other data sets, all observations were grouped into latitude intervals of:

-   1° x 1°

```{r grid_spatially_1x1}

GLODAP <- m_grid_horizontal(GLODAP)

```

## Apply basin mask

```{r apply_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)

GLODAP <- inner_join(GLODAP, basinmask)

```

## Add row number

```{r add_row_number}

GLODAP <- GLODAP  %>%  
  mutate(row_number = row_number()) %>% 
  relocate(row_number)

```

## Split CO2 and tracers

```{r split_co2_tracer}

# remove irrelevant columns
GLODAP <- GLODAP %>%
  select(-c(region,
            month:minute,
            maxsampdepth, bottle, sigma0:sigma4,
            nitrite:nitritef))


GLODAP_tracer <- GLODAP %>% 
  select(row_number:gamma,
         cfc11:sf6f,
         basin_AIP)

# select relevant columns
GLODAP <- GLODAP %>%
  select(row_number:talkqc,
         basin_AIP)


```


## Subset tco2 data

The vast majority of rows is removed due to missing `tco2` observations.

```{r tco2_na_subset}

GLODAP <- GLODAP %>% 
  filter(!is.na(tco2))

```

## Subset tracer data

Rows are removed if no tracer observation is available.

```{r tracer_na_subset}

GLODAP_tracer <- GLODAP_tracer %>%
  filter(if_any(
    c(
      cfc11,
      cfc12,
      cfc113,
      ccl4,
      sf6,
      pcfc11,
      pcfc12,
      pcfc113,
      pccl4,
      psf6
    ),
    ~ !is.na(.)
  ))

```

## Create clean observations grid

### CO2

```{r create_clean_obs_grid}

GLODAP_obs_grid <- GLODAP %>% 
  count(lat, lon)

```


```{r grid_by_year, fig.asp=3}

GLODAP_grid_year <- GLODAP %>%
  count(lat, lon, year)

map +
  geom_raster(data = GLODAP_grid_year,
              aes(lon, lat)) +
  facet_wrap(~ year, ncol=3)

```

### Tracer

```{r create_clean_obs_grid_tracer}

GLODAP_obs_grid_tracer <- GLODAP_tracer %>% 
  count(lat, lon)

```


```{r grid_by_year_tracer, fig.asp=3}

GLODAP_grid_year_tracer <- GLODAP_tracer %>%
  count(lat, lon, year)

map +
  geom_raster(data = GLODAP_grid_year_tracer,
              aes(lon, lat)) +
  facet_wrap(~ year, ncol=3)

```


# Flagging

## qc

```{r qc_flagging, fig.asp=1.5}

qc_flag <- full_join(
  GLODAP,
  GLODAP_expocodes
)

qc_flag <- qc_flag %>%
  mutate(decade = cut(
    year,
    seq(1990, 2020, 10),
    right = FALSE,
    labels = c("1990-1999", "2000-2009", "2010-2019")
  ),
  .after = year) %>%
  filter(!is.na(decade)) %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("qc")) %>%
  pivot_longer(ends_with("qc"),
               names_to = "parameter",
               values_to = "value")

qc_flag_grid <- qc_flag %>%
  count(lon, lat, decade, parameter, value)

p_qc_flag_map <- qc_flag_grid %>% 
  group_split(value) %>%
  # head(1) %>% 
  map(
    ~map +
  geom_tile(data = .x,
            aes(lon, lat, fill=n)) +
  facet_grid(parameter ~ decade) +
  labs(title = paste("qc flag =", unique(.x$value))) +
    scale_fill_viridis_c(option = "magma",
                         direction = -1,
                         trans = "log10")
  )

p_qc_flag_map

pdf("output/qc_flag_coverage_maps.pdf")
p_qc_flag_map
dev.off()

qc_flag %>% 
  filter(basin_AIP == "Pacific",
         decade == "1990-1999") %>% 
  count(cruise_expocode, parameter, value) %>% 
  arrange(value, -n) %>% 
  write_csv("output/Pacific_1990_qc_by_cruise_and_parameter.csv")

rm(qc_flag, qc_flag_grid, p_qc_flag_map)

```

## f

```{r f_flagging, fig.asp=1.5}

f_flag <- full_join(
  GLODAP,
  GLODAP_expocodes
)

f_flag <- f_flag %>%
  mutate(decade = cut(
    year,
    seq(1990, 2020, 10),
    right = FALSE,
    labels = c("1990-1999", "2000-2009", "2010-2019")
  ),
  .after = year) %>%
  filter(!is.na(decade)) %>% 
  select(lon, lat, basin_AIP, decade, cruise_expocode, ends_with("f")) %>%
  pivot_longer(ends_with("f"),
               names_to = "parameter",
               values_to = "value")

f_flag_grid <- f_flag %>%
  count(lon, lat, decade, parameter, value)

p_f_flag_map <- f_flag_grid %>% 
  group_split(value) %>%
  # head(1) %>% 
  map(
    ~map +
  geom_tile(data = .x,
            aes(lon, lat, fill=n)) +
  facet_grid(parameter ~ decade) +
  labs(title = paste("f flag =", unique(.x$value))) +
    scale_fill_viridis_c(option = "magma",
                         direction = -1,
                         trans = "log10")
  )

p_f_flag_map

pdf("output/f_flag_coverage_maps.pdf")
p_f_flag_map
dev.off()

f_flag %>% 
  filter(basin_AIP == "Pacific",
         decade == "1990-1999") %>% 
  count(cruise_expocode, parameter, value) %>% 
  arrange(value, -n) %>% 
  write_csv("output/Pacific_1990_f_by_cruise_and_parameter.csv")

rm(f_flag, f_flag_grid, p_f_flag_map)

```

## P18 phosphate


```{r P18_nitrate}

P18 <- full_join(
  GLODAP,
  GLODAP_expocodes
)

P18 <- P18 %>% 
  filter(cruise_expocode %in% c("33RO20161119",
                                "33RO20071215",
                                "31DS19940126"))


P18 %>% 
  filter(!is.na(nitrate)) %>% 
  ggplot(aes(lat, depth, col= nitrate)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(cruise_expocode ~.)

P18_grid <- P18 %>% 
  select(lat, lon, depth, cruise_expocode, nitrate) %>% 
  mutate(depth = as.numeric(as.character(cut(depth,
                     seq(0,1e4, 500), 
                     seq(250,1e4,500))))) %>% 
  group_by(lat, depth, cruise_expocode) %>% 
  summarise(nitrate = mean(nitrate, na.rm=TRUE)) %>% 
  ungroup()

P18_grid %>% 
  ggplot(aes(lat, depth, col= nitrate)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(cruise_expocode ~.)

P18_grid %>% 
  pivot_wider(names_from = cruise_expocode,
              values_from = nitrate) %>% 
  mutate(delta_nitrate_1994_2007 = `31DS19940126` - `33RO20071215`,
         delta_nitrate_1994_2016 = `31DS19940126` - `33RO20161119`,
         delta_nitrate_2007_2016 = `33RO20071215` - `33RO20161119`) %>% 
  select(lat, depth, starts_with("delta")) %>% 
  pivot_longer(starts_with("delta"),
               values_to = "delta_nitrate",
               names_to = "years",
               names_prefix = "delta_nitrate_") %>% 
  filter(delta_nitrate > -20,
         depth > 1500) %>% 
  ggplot(aes(lat, depth, col= delta_nitrate)) +
  geom_point() +
  scale_color_divergent() +
  scale_y_reverse() +
  facet_grid(years ~.)

rm(P18, P18_grid)

```


```{r P18_nitrate_phosphate}

P18 <- full_join(
  GLODAP,
  GLODAP_expocodes
)

P18 <- P18 %>% 
  filter(cruise_expocode %in% c("33RO20161119",
                                "33RO20071215",
                                "31DS19940126"))

P18 <- P18 %>% 
  mutate(nitrate = nitrate / phosphate)


P18 %>% 
  filter(!is.na(nitrate)) %>% 
  ggplot(aes(lat, depth, col= nitrate)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(cruise_expocode ~.)

P18_grid <- P18 %>% 
  select(lat, lon, depth, cruise_expocode, nitrate) %>% 
  mutate(depth = as.numeric(as.character(cut(depth,
                     seq(0,1e4, 500), 
                     seq(250,1e4,500))))) %>% 
  group_by(lat, depth, cruise_expocode) %>% 
  summarise(nitrate = mean(nitrate, na.rm=TRUE)) %>% 
  ungroup()

P18_grid %>% 
  ggplot(aes(lat, depth, col= nitrate)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(cruise_expocode ~.)

P18_grid %>% 
  pivot_wider(names_from = cruise_expocode,
              values_from = nitrate) %>% 
  mutate(delta_nitrate_1994_2007 = `31DS19940126` - `33RO20071215`,
         delta_nitrate_1994_2016 = `31DS19940126` - `33RO20161119`,
         delta_nitrate_2007_2016 = `33RO20071215` - `33RO20161119`) %>% 
  select(lat, depth, starts_with("delta")) %>% 
  pivot_longer(starts_with("delta"),
               values_to = "delta_nitrate",
               names_to = "years",
               names_prefix = "delta_nitrate_") %>% 
  filter(delta_nitrate > -20,
         depth > 1500) %>% 
  ggplot(aes(lat, depth, col= delta_nitrate)) +
  geom_point() +
  scale_color_divergent() +
  scale_y_reverse() +
  facet_grid(years ~.)

rm(P18, P18_grid)

```


# Adjustments

Typically, the reasons for multiple expocode entries of the same cruise in the adjustment table list are:

1) The cruise adjustments are different for different station, i.e. station split (e.g. 316N19821201)

-> How to merge? Based on first and last station? Cruise_ID not in GLODAP merged master file.

2) The cruise adjustments are different for different legs (e.g. 316N19871123.6) but have been merged into one cruise (316N19871123) for the product

-> How to merge? Based on first and last station?

3) The cruise adjustments have been updated/changed through the versions, here always look for the most recent entry (see table below) (e.g. 320620180309)

For the expocodes not listed in the expocode list the reason is that INDIGO has been splitted into three cruises: 35MF1985-1987 and the same holds for SAVE (316N1987 - 6legs). Further 49HH20011208 has been assigned wrongly and corrected to 49HH20011127.

Remove expocode INDIGO and maintain only 35MF19850224.
Remove expocode SAVE and maintain only 316N1987.


```{r prepare_adjustments}

GLODAP_adjustments <- GLODAP_adjustments %>%
  select(cruise_expocode,
         first_station, last_station,
         version,
         calculated_carbon_parameter,
         ends_with("_adj")) %>% 
  rename(talk_adj = alkalinity_adj)

# Remove cruises INDIGO and SAVE

GLODAP_adjustments <- 
  GLODAP_adjustments %>% 
  filter(!(cruise_expocode %in% c("INDIGO", "SAVE")))

# correct expocode 49HH20011208 to 49HH20011127

GLODAP_adjustments <- 
  GLODAP_adjustments %>% 
  mutate(cruise_expocode = if_else(
    cruise_expocode == "49HH20011208",
    "49HH20011127",
    cruise_expocode
  ))


# select latest adjustment versions

GLODAP_adjustments <- 
  GLODAP_adjustments %>% 
  group_by(cruise_expocode, first_station) %>% 
  mutate(n = n(),
         version_max = max(version)) %>%
  ungroup() %>% 
  filter(version == version_max | is.na(version)) %>% 
  select(-c(version_max, version, n))

# harmonize multiple cruise expocodes of 316N1987

GLODAP_adjustments <- GLODAP_adjustments %>% 
  # filter(str_detect(cruise_expocode, "\\.")) %>% 
  mutate(cruise_expocode = str_split(cruise_expocode,
                                     "\\.",
                                     simplify = TRUE)[,1])

# correct one wrong last_cruise label

GLODAP_adjustments <- GLODAP_adjustments %>%
  mutate(
    last_station = if_else(
      cruise_expocode == "318M20091121" &
        first_station == 1,
      127,
      last_station
    )
  )

# merge with expocode table
GLODAP_adjustments <- full_join(GLODAP_adjustments, GLODAP_expocodes) %>% 
  relocate(cruise)



GLODAP_adjustments_NA_cruises <- 
  GLODAP_adjustments %>% 
  filter(is.na(cruise))

GLODAP_adjustments_duplicated_cruises <- 
  GLODAP_adjustments %>% 
  group_by(cruise_expocode, cruise) %>% 
  mutate(n = n()) %>%
  ungroup() %>% 
  filter(n != 1)


GLODAP_adjustments %>% 
  pivot_longer(salinity_adj:c13_adj,
               names_to = "parameter",
               values_to = "adjustment") %>% 
  ggplot(aes(adjustment)) +
  geom_histogram() +
  scale_y_log10() +
  facet_wrap(~ parameter, scales = "free_x")


```

# RV activity

```{r RV_activity}

RV_activity <- full_join(
  GLODAP,
  GLODAP_expocodes
)

RV_activity <- RV_activity %>%
  mutate(decade = cut(
    year,
    seq(1990, 2020, 10),
    right = FALSE,
    labels = c("1990-1999", "2000-2009", "2010-2019")
  ), .after = year) %>% 
  filter(!is.na(decade))

RV_activity <- RV_activity %>% 
  mutate(RV = str_sub(cruise_expocode, 1, 4))

RV_activity <- RV_activity %>% 
  count(decade, basin_AIP, RV) %>% 
  group_by(decade, basin_AIP) %>% 
  mutate(n_total = sum(n)) %>% 
  ungroup() %>% 
  mutate(n_prop = 100* n / n_total)

RV_activity <-RV_activity %>% 
  group_by(decade, basin_AIP) %>% 
  mutate(rank = rank(-n_prop)) %>% 
  ungroup()

RV_activity %>% 
  ggplot(aes(rank, n_prop)) +
  geom_line() +
  geom_point() +
  geom_text(data = RV_activity %>% filter(n_prop > 20),
             aes(rank, n_prop, label = RV),
             nudge_x = 5) +
  labs(y = "proportion of tco2 samples (%)") +
  facet_grid(decade ~ basin_AIP)

rm(RV_activity)

```


# Crossover checks

## Indian N-S

```{r IO_NS_data}

IO_NS_cruises <- c(249, 250,
                       352, 353,
                       1046,
                       3035)

IO_NS_GLODAP_grid <- GLODAP %>% 
  filter(basin_AIP == "Indian",
         lon > 70,
         lon < 100,
         cruise %in% IO_NS_cruises
         ) %>%
  mutate(cruise = as.factor(cruise)) %>% 
  distinct(lon, lat, cruise, year = as.factor(year(date)))

map +
  geom_tile(data = IO_NS_GLODAP_grid,
            aes(lon, lat, fill = year)) +
  facet_wrap(~ year)


IO_NS <- GLODAP %>% 
  filter(cruise %in% IO_NS_cruises)

IO_NS <- IO_NS %>%
  mutate(
    cstar = tco2  - (117 * phosphate)  - 0.5 * (talk - (16 * phosphate)),
    cstar_tco2 = tco2,
    cstar_talk = -0.5 * talk,
    cstar_phosphate = -117 * phosphate + 16 * 0.5 * phosphate
  )


IO_NS <- IO_NS %>%
  select(year,
         lon, lat, depth,
         cruise, station, cast,
         temp, sal, gamma,
         tco2, talk, phosphate,
         starts_with("cstar"))


IO_NS <- IO_NS %>% 
  mutate(year = if_else(year == 1994, 1995, year),
         year = as.factor(as.character(year)))

IO_NS <- IO_NS %>% 
  filter(lon < 98)

IO_NS <- IO_NS %>% 
  filter(lat > -25,
         lat < 0,
         depth > 2000,
         depth < 4000,
         !(lat %in% c(-18.5,-5.5)))

map +
  geom_tile(data = IO_NS %>% 
              distinct(lon, lat, year),
            aes(lon, lat, fill = year)) +
  facet_wrap(~ year, ncol = 2)


IO_NS <- IO_NS %>% 
  pivot_longer(temp:cstar_phosphate,
               names_to = "parameter",
               values_to = "value")

```

### Section

```{r IO_NS_sections}


IO_NS %>% 
  group_split(parameter) %>% 
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(lat , depth, col = value)) +
  geom_point() +
  scale_color_viridis_c(name = unique(.x$parameter)) +
  scale_y_reverse() +
  facet_grid(year ~ .)
  )


```

### Profiles, absolute

```{r IO_NS_profiles, fig.asp=2}

IO_NS %>%
  arrange(depth) %>% 
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(
               value , depth, fill = year,
             )) +
      geom_point(shape = 21) +
      scale_fill_scico_d(direction = -1) +
      scale_y_reverse() +
      labs(x = unique(.x$parameter)) +
      facet_wrap( ~ lat, ncol = 3)
  )

```


```{r IO_NS_profiles_gridded, fig.asp=1.5}

IO_NS_grid <- IO_NS %>% 
  select(lat, lon, depth, year, parameter, value) %>% 
  mutate(depth = as.numeric(as.character(cut(depth,
                     seq(0,1e4, 500), 
                     seq(250,1e4,500))))) %>% 
  group_by(lat, depth, year, parameter) %>% 
  summarise(value = mean(value, na.rm=TRUE)) %>% 
  ungroup()


IO_NS_grid %>%
  group_by(depth, year, parameter) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(value , depth, fill = year)) +
  geom_point(shape = 21) +
  scale_fill_scico_d(direction = -1) +
  scale_y_reverse() +
  facet_wrap(~ parameter, scales = "free_x", ncol = 3)
  
```

### Profiles, offset

```{r IO_NS_profiles_gridded_offset, fig.asp=2}

IO_NS_grid_offset <- IO_NS_grid %>% 
  arrange(year) %>% 
  group_by(lat, depth, parameter) %>% 
  mutate(delta_value = value - lag(value),
         delta_year = paste(lag(year), year, sep = "-")) %>% 
  ungroup() %>% 
  drop_na()

IO_NS_grid_offset %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(
               delta_value , depth, fill = delta_year,
             )) +
      geom_vline(xintercept = 0) +
      geom_point(shape = 21) +
      scale_fill_scico_d(direction = -1) +
      scale_y_reverse() +
      labs(x = unique(.x$parameter)) +
      facet_wrap( ~ lat, ncol = 3)
  )

```

### Mean offset

```{r IO_NS_mean_offset}

IO_NS_grid_offset_mean <-
  IO_NS_grid_offset %>%
  group_by(parameter, delta_year) %>%
  summarise(mean_delta_value = mean(delta_value),
            sd_delta_value = sd(delta_value)) %>%
  ungroup()

IO_NS_grid_offset_mean %>% 
  filter(str_detect(parameter, "cstar")) %>% 
  ggplot(aes(delta_year, mean_delta_value,
             ymin = mean_delta_value - sd_delta_value,
             ymax = mean_delta_value + sd_delta_value)) +
  geom_hline(yintercept = 0) +
  geom_pointrange() +
  facet_wrap(~ parameter)

IO_NS_grid_offset_mean %>% 
  filter(!(str_detect(parameter, "cstar"))) %>% 
  ggplot(aes(delta_year, mean_delta_value,
             ymin = mean_delta_value - sd_delta_value,
             ymax = mean_delta_value + sd_delta_value)) +
  geom_hline(yintercept = 0) +
  geom_pointrange() +
  facet_wrap(~ parameter, scales = "free_y")


```


## Indian E-W

```{r IO_EW_data}

IO_EW_cruises <- c(252, 488)

IO_EW_GLODAP_grid <- GLODAP %>% 
  filter(basin_AIP == "Indian",
         lat > -25,
         lat < -15,
         cruise %in% IO_EW_cruises
         ) %>%
  mutate(cruise = as.factor(cruise)) %>% 
  distinct(lon, lat, cruise, year = as.factor(year(date)))

map +
  geom_tile(data = IO_EW_GLODAP_grid,
            aes(lon, lat, fill = year)) +
  facet_wrap(~ year)


IO_EW <- GLODAP %>% 
  filter(cruise %in% IO_EW_cruises)

IO_EW <- IO_EW %>%
  mutate(
    cstar = tco2  - (117 * phosphate)  - 0.5 * (talk - (16 * phosphate)),
    cstar_tco2 = tco2,
    cstar_talk = -0.5 * talk,
    cstar_phosphate = -117 * phosphate + 16 * 0.5 * phosphate
  )


IO_EW <- IO_EW %>%
  select(year,
         lon, lat, depth,
         cruise, station, cast,
         temp, sal, gamma,
         tco2, talk, phosphate,
         starts_with("cstar"))


IO_EW <- IO_EW %>% 
  mutate(year = if_else(year == 2003, 2004, year),
         year = as.factor(as.character(year)))

IO_EW <- IO_EW %>% 
  filter(lon > 48)

IO_EW <- IO_EW %>% 
  filter(depth > 2000,
         depth < 4000)

map +
  geom_tile(data = IO_EW %>% 
              distinct(lon, lat, year),
            aes(lon, lat, fill = year)) +
  # geom_vline(xintercept = 48) +
  facet_wrap(~ year, ncol = 2)


IO_EW <- IO_EW %>% 
  pivot_longer(temp:cstar_phosphate,
               names_to = "parameter",
               values_to = "value")

```

### Section

```{r IO_EW_sections, fig.asp=1}


IO_EW %>% 
  group_split(parameter) %>% 
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(lon , depth, col = value)) +
  geom_point() +
  scale_color_viridis_c() +
  scale_y_reverse() +
  facet_grid(year ~ parameter)
  )


```

### Profiles, absolute

```{r IO_EW_profiles, fig.asp=3}

IO_EW %>%
  arrange(depth) %>% 
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(
               value , depth, fill = year,
             )) +
      geom_point(shape = 21) +
      scale_fill_scico_d(direction = -1) +
      scale_y_reverse() +
      labs(x = unique(.x$parameter)) +
      facet_wrap( ~ lon, ncol = 3)
  )

```

```{r IO_EW_profiles_gridded, fig.asp=2}

IO_EW_grid <- IO_EW %>% 
  select(lon, lat, depth, year, parameter, value) %>% 
  mutate(depth = as.numeric(as.character(cut(depth,
                     seq(0,1e4, 500), 
                     seq(250,1e4,500))))) %>% 
  group_by(lon, depth, year, parameter) %>% 
  summarise(value = mean(value, na.rm=TRUE)) %>% 
  ungroup()


IO_EW_grid %>%
  group_by(depth, year, parameter) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(value , depth, fill = year)) +
  geom_point(shape = 21) +
  scale_fill_scico_d(direction = -1) +
  scale_y_reverse() +
  facet_wrap(~ parameter, scales = "free_x", ncol = 3)

```

### Profiles, offset

```{r IO_EW_profiles_gridded_offset, fig.asp=3}

IO_EW_grid_offset <- IO_EW_grid %>% 
  arrange(year) %>% 
  group_by(lon, depth, parameter) %>% 
  mutate(delta_value = value - lag(value),
         delta_year = paste(lag(year), year, sep = "-")) %>% 
  ungroup() %>% 
  drop_na()

IO_EW_grid_offset %>%
  group_split(parameter) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(
               delta_value , depth, fill = delta_year,
             )) +
      geom_vline(xintercept = 0) +
      geom_point(shape = 21) +
      scale_fill_scico_d(direction = -1) +
      scale_y_reverse() +
      labs(x = unique(.x$parameter)) +
      facet_wrap( ~ lon, ncol = 3)
  )

```

### Mean offset

```{r IO_EW_mean_offset}

IO_EW_grid_offset_mean <-
  IO_EW_grid_offset %>%
  group_by(parameter, delta_year) %>%
  summarise(mean_delta_value = mean(delta_value),
            sd_delta_value = sd(delta_value)) %>%
  ungroup()

IO_EW_grid_offset_mean %>% 
  filter(str_detect(parameter, "cstar")) %>% 
  ggplot(aes(delta_year, mean_delta_value,
             ymin = mean_delta_value - sd_delta_value,
             ymax = mean_delta_value + sd_delta_value)) +
  geom_hline(yintercept = 0) +
  geom_pointrange() +
  facet_wrap(~ parameter)

IO_EW_grid_offset_mean %>% 
  filter(!(str_detect(parameter, "cstar"))) %>% 
  ggplot(aes(delta_year, mean_delta_value,
             ymin = mean_delta_value - sd_delta_value,
             ymax = mean_delta_value + sd_delta_value)) +
  geom_hline(yintercept = 0) +
  geom_pointrange() +
  facet_wrap(~ parameter, scales = "free_y")


```

## Indian N-S + E-W

```{r IO_NS_EW_map}

map +
  geom_tile(data = IO_EW %>% 
              distinct(lon, lat, year),
            aes(lon, lat)) +
  geom_tile(data = IO_NS %>% 
              distinct(lon, lat, year),
            aes(lon, lat)) +
  xlim(c(20,150)) +
  ylim(c(-80, 40))


```


```{r IO_NS_EW_profiles_gridded, fig.asp=1}


IO_NS_EW_grid <-
  bind_rows(
    IO_NS_grid %>%
      filter(year %in% c("1995", "2007")) %>%
      mutate(year = recode(year, "2007" = "2004"),
             lon = 999),
    IO_EW_grid %>%
      mutate(lat = 999)
  ) %>%
  mutate(year = recode(year, "2004" = "2000s", "1995" = "1990s"))

IO_NS_EW_grid %>%
  filter(parameter %in% c("cstar", "tco2", "talk", "phosphate")) %>%
  group_by(depth, year, parameter) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(value , depth, fill = year, col = year)) +
  geom_path() +
  geom_point(shape = 21) +
  scale_color_brewer(palette = "Set1",
                    name = "decade") +
  scale_fill_brewer(palette = "Set1",
                    name = "decade") +
  scale_y_reverse() +
  facet_wrap( ~ parameter, scales = "free_x", ncol = 2)


IO_NS_EW_grid %>%
  filter(!(parameter %in% c("cstar", "tco2", "talk", "phosphate"))) %>% 
  group_by(depth, year, parameter) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(value , depth, fill = year)) +
  geom_point(shape = 21) +
  scale_fill_scico_d(direction = -1) +
  scale_y_reverse() +
  facet_wrap(~ parameter, scales = "free_x", ncol = 3)

IO_NS_EW_grid_offset <- IO_NS_EW_grid %>% 
  arrange(year) %>% 
  group_by(lat, lon, depth, parameter) %>% 
  mutate(delta_value = value - lag(value),
         delta_year = paste(lag(year), year, sep = "-")) %>% 
  ungroup() %>% 
  drop_na()

```


### Mean offset

```{r IO_NS_EW_mean_offset}

IO_NS_EW_grid_offset_mean <-
  IO_NS_EW_grid_offset %>%
  group_by(parameter, delta_year) %>%
  summarise(mean_delta_value = mean(delta_value),
            sd_delta_value = sd(delta_value)) %>%
  ungroup()

IO_NS_EW_grid_offset_mean %>% 
  filter(str_detect(parameter, "cstar")) %>% 
  ggplot(aes(delta_year, mean_delta_value,
             ymin = mean_delta_value - sd_delta_value,
             ymax = mean_delta_value + sd_delta_value)) +
  geom_hline(yintercept = 0) +
  geom_pointrange() +
  facet_wrap(~ parameter)

IO_NS_EW_grid_offset_mean %>% 
  filter(!(str_detect(parameter, "cstar"))) %>% 
  ggplot(aes(delta_year, mean_delta_value,
             ymin = mean_delta_value - sd_delta_value,
             ymax = mean_delta_value + sd_delta_value)) +
  geom_hline(yintercept = 0) +
  geom_pointrange() +
  facet_wrap(~ parameter, scales = "free_y")


```


# Write files

```{r write_clean_data_files}

GLODAP  %>%
  write_csv(paste(path_preprocessing,
                  "GLODAPv2.2021_preprocessed.csv",
                  sep = ""))

GLODAP_tracer  %>%
  write_csv(paste(
    path_preprocessing,
    "GLODAPv2.2021_preprocessed_tracer.csv",
    sep = ""
  ))

GLODAP_adjustments  %>%
  write_csv(paste(path_preprocessing,
                  "GLODAPv2.2021_adustments.csv",
                  sep = ""))

# GLODAP_adjustments_NA_cruises  %>%
#   select(cruise_expocode, cruise) %>%
#   write_csv(paste(
#     path_preprocessing,
#     "GLODAPv2.2021_adustments_NA_cruises.csv",
#     sep = ""
#   ))
# 
# GLODAP_adjustments_duplicated_cruises  %>%
#   drop_na() %>%
#   write_csv(
#     paste(
#       path_preprocessing,
#       "GLODAPv2.2021_adustments_duplicated_cruises.csv",
#       sep = ""
#     )
#   )

```

# Overview plots

## Assign coarse spatial grid

For the following plots, the cleaned data set was re-opened and observations were gridded spatially to intervals of:

-   5° x 5°

```{r grid_spatially_5x5}

GLODAP <- m_grid_horizontal_coarse(GLODAP)

```

## Histogram Zonal coverage

```{r coverage_histogram_zonal}

GLODAP_histogram_lat <- GLODAP %>%
  group_by(lat_grid) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_lat %>%
  ggplot(aes(lat_grid, n)) +
  geom_col() +
  coord_flip() +
  theme(legend.title = element_blank())

rm(GLODAP_histogram_lat)

```

## Histogram temporal coverage

```{r coverage_histogram_temporal}

GLODAP_histogram_year <- GLODAP %>%
  group_by(year) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_year %>%
  ggplot() +
  geom_col(aes(year, n)) +
  theme(
    axis.title.x = element_blank()
  )

rm(GLODAP_histogram_year)

```

## Zonal temporal coverage (Hovmoeller)

```{r coverage_hovmoeller}

GLODAP_hovmoeller_year <- GLODAP %>%
  group_by(year, lat_grid) %>%
  tally() %>%
  ungroup()

GLODAP_hovmoeller_year %>%
  ggplot(aes(year, lat_grid, fill = log10(n))) +
  geom_tile() +
  geom_vline(xintercept = c(1999.5, 2012.5)) +
  scale_fill_viridis_c(option = "magma", direction = -1) +
  theme(legend.position = "top",
        axis.title.x = element_blank())

rm(GLODAP_hovmoeller_year)

```

## Coverage map

```{r coverage_map, fig.asp=0.5}

map +
  geom_raster(data = GLODAP_obs_grid,
              aes(lon, lat, fill = log10(n))) +
  scale_fill_viridis_c(option = "magma",
                       direction = -1)

```

```{r coverage_map_variable_year, message=FALSE}

GLODAP_obs_grid_all_vars <- GLODAP %>% 
  select(year, lat, lon, cruise, sal, temp, oxygen,
         phosphate, nitrate, silicate, tco2, talk) %>% 
  pivot_longer(cols = sal:talk,
               names_to = "parameter",
               values_to = "value") %>% 
  mutate(presence = if_else(is.na(value), "missing", "available")) %>% 
  count(year, lat, lon, parameter, presence)

GLODAP_obs_grid_all_vars_wide <- GLODAP_obs_grid_all_vars %>% 
  pivot_wider(names_from = "presence",
              values_from = n,
              values_fill = 0) %>% 
  mutate(ratio_available = available/(available+missing))

all_plots <- GLODAP_obs_grid_all_vars_wide %>%
  # mutate(cruise = as.factor(cruise)) %>%
  group_split(year) %>%
  # tail(3) %>%
  map(
    ~ map +
      geom_tile(
        data = .x,
        aes(
          x = lon,
          y = lat,
          width = 1,
          height = 1,
          fill = ratio_available
        )
      ) +
      scale_fill_scico(palette = "berlin",
                       limits = c(0,1)) +
      labs(title = unique(.x$year)) +
      facet_wrap(~ parameter)
  )


pdf(file = paste0(path_preprocessing, "GLODAPv2.2021_preprocessed_coverage_maps.pdf"),
    width = 10, 
    height = 5)
all_plots
dev.off()

```

## Time series

```{r timeseries, fig.asp=1.5}

GLODAP_time_series <- GLODAP %>% 
  select(year, basin_AIP, lat, depth, sal, temp,
         oxygen, aou, nitrate, silicate, phosphate,
         tco2, talk)

GLODAP_time_series <- GLODAP_time_series %>% 
  mutate(depth_grid = cut(depth, seq(0,1e4,1000)))

GLODAP_time_series <- GLODAP_time_series %>% 
  pivot_longer(sal:talk,
               names_to = "parameter",
               values_to = "value") %>% 
  filter(!is.na(value),
         !is.na(depth_grid))

GLODAP_time_series %>%
  group_split(basin_AIP, depth_grid) %>%
  # head(1) %>%
  map(
    ~ ggplot(data = .x,
             aes(year, value, col = lat)) +
      geom_jitter(alpha = 0.1) +
      scale_color_divergent() +
      facet_grid(parameter ~ depth_grid,
                 scales = "free_y") +
      labs(title = paste(
        "basin_AIP:",
        unique(.x$basin_AIP),
        "| depth_grid:",
        unique(.x$depth_grid)
      ))
  )



```


# CANYON-B

## Comparison to GLODAP

```{r CANYON-B, fig.asp=0.4}

source("/net/kryo/work/uptools/co2_calculation/CANYON-B/CANYONB.R")

GLODAP_Can_B <- GLODAP %>%
  mutate(lon = if_else(lon > 180, lon - 360, lon)) %>%
  arrange(year) %>% 
  select(row_number, year, date, lat, lon, depth, basin_AIP,
         temp, sal, oxygen,
         talk, tco2, nitrate, phosphate, silicate)

# filter rows with essential variables for Canyon-B
GLODAP_Can_B <- GLODAP_Can_B %>%
  filter(across(c(lat, lon, depth,
                  temp, sal, oxygen), ~ !is.na(.x)))

GLODAP_Can_B <- GLODAP_Can_B %>%
  mutate(as_tibble(
    CANYONB(
      date = paste0(as.character(date), " 12:00"),
      lat = lat,
      lon = lon,
      pres = depth,
      temp = temp,
      psal = sal,
      doxy = oxygen,
      param = c("AT", "CT", "NO3", "PO4", "SiOH4")
    )
  ))

GLODAP_Can_B <- GLODAP_Can_B %>%
  select(-ends_with(c("_cim", "_cin", "_cii")))


GLODAP_Can_B <- GLODAP_Can_B %>%
  rename(
    "talk_CANYONB" = "AT",
    "tco2_CANYONB" = "CT",
    "nitrate_CANYONB" = "NO3",
    "phosphate_CANYONB" = "PO4",
    "silicate_CANYONB" = "SiOH4"
  )


variables <- c("talk", "tco2", "nitrate", "phosphate", "silicate")

for (i_variable in variables) {
  # i_variable <- variables[1]
  
  # calculate equal axis limits and binwidth
  axis_lims <- GLODAP_Can_B %>%
    drop_na() %>% 
    summarise(max_value = max(c(max(
      !!sym(i_variable)
    ),
    max(!!sym(
      paste0(i_variable, "_CANYONB")
    )))),
    min_value = min(c(min(
      !!sym(i_variable)
    ),
    min(!!sym(
      paste0(i_variable, "_CANYONB")
    )))))
  
  binwidth_value <- (axis_lims$max_value - axis_lims$min_value) / 60
  axis_lims <- c(axis_lims$min_value, axis_lims$max_value)
  
  print(
    ggplot(GLODAP_Can_B, aes(
      x = !!sym(i_variable),
      y = !!sym(paste0(i_variable, "_CANYONB"))
    )) +
      geom_bin2d(binwidth = binwidth_value) +
      scale_fill_viridis_c(trans = "log10") +
      geom_abline(slope = 1, col = 'red') +
      coord_equal(xlim = axis_lims,
                  ylim = axis_lims) +
      facet_wrap( ~ basin_AIP) +
      labs(title = "All years")
  ) 
  
  
  # for (i_year in unique(GLODAP_Can_B$year)) {
  #   # i_year <- 2017
  #   
  #   print(
  #     ggplot(
  #       GLODAP_Can_B %>% filter(year == i_year),
  #       aes(x = !!sym(i_variable),
  #           y = !!sym(paste0(
  #             i_variable, "_CANYONB"
  #           )))
  #     ) +
  #       geom_bin2d(binwidth = binwidth_value) +
  #       scale_fill_viridis_c(trans = "log10") +
  #       geom_abline(slope = 1, col = 'red') +
  #       coord_equal(xlim = axis_lims,
  #                   ylim = axis_lims) +
  #       facet_wrap( ~ basin_AIP) +
  #       labs(title = paste("Year:", i_year))
  #   )
  # }
  
}



```

## Write Canyon-B file

```{r write_Canyon-B_data_file}

GLODAP_Can_B %>% 
  select(row_number,
         talk_CANYONB, tco2_CANYONB,
         nitrate_CANYONB, phosphate_CANYONB, silicate_CANYONB) %>% 
  write_csv(paste(path_preprocessing,
                             "GLODAPv2.2021_Canyon-B.csv",
                             sep = ""))

```
